<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" src="/others/pulse.png" />
  <title>Pulse - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-r from-gray-900 to-gray-800 font-sans text-white antialiased min-h-screen">
  <div class="sidebar group fixed left-0 top-0 h-full w-14 bg-gray-900 flex flex-col items-center py-4 overflow-y-auto overflow-x-hidden border-r border-gray-700 transition-all duration-200 hover:w-52">
    <div class="flex flex-col items-center gap-4 pt-4 w-full">
      <div class="server-item active w-full mx-auto p-2 rounded-md flex items-center hover:bg-gray-700 cursor-pointer group/item" onclick="window.location.href='/'">
        <img src="/others/pulse.png" alt="Server Icon" class="w-8 h-8 rounded-full mr-2" />
        <span class="text-gray-300 font-medium group-hover:opacity-100 transition-all duration-200 opacity-0 group-hover:w-auto w-0 text-ellipsis whitespace-nowrap">Home</span>
      </div>
      <div class="server-item w-full mx-auto p-2 rounded-md flex items-center hover:bg-gray-700 cursor-pointer group/item" onclick="window.location.href='/account'">
        <img src="<%= user.profilepicture %>" alt="User Profile" class="w-8 h-8 rounded-full mr-2" />
        <span class="text-gray-300 font-medium group-hover:opacity-100 transition-all duration-200 opacity-0 group-hover:w-auto w-0 text-ellipsis whitespace-nowrap">Account</span>
      </div>
      <div class="w-full h-px bg-gray-700 my-4"></div>

      <div id="createGroupChatButton" class="server-item w-full mx-auto p-2 rounded-md flex items-center hover:bg-gray-700 cursor-pointer group/item">
        <span class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-700 text-gray-300">
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm-6 14c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1H6v-1zm12-4h-2v-2h-2v2h-2v2h2v2h2v-2h2v-2z" fill="currentColor"/>
          </svg>
        </span>
        <span class="text-gray-300 font-medium ml-2 group-hover:opacity-100 transition-all duration-200 opacity-0 group-hover:w-auto w-0 text-ellipsis whitespace-nowrap">Create Group Chat</span>
      </div>

      <% if (typeof groupChats !== 'undefined' && groupChats.length > 0) { %>
        <div class="w-full h-px bg-gray-700 my-4"></div>
        <% groupChats.forEach(groupChat => { %>
          <div class="server-item w-full mx-auto p-2 rounded-md flex items-center hover:bg-gray-700 cursor-pointer group/item" onclick="window.location.href='/gc/<%= groupChat.id %>'">
            <span class="w-8 h-8 rounded-full mr-2 flex items-center justify-center bg-blue-700 text-white text-sm font-bold">GC</span>
            <span class="text-gray-300 font-medium group-hover:opacity-100 transition-all duration-200 opacity-0 group-hover:w-auto w-0 text-ellipsis whitespace-nowrap"><%= groupChat.name %></span>
          </div>
        <% }) %>
        <div class="w-full h-px bg-gray-700 my-4"></div>
      <% } %>

      <% if (user && user.friends && user.friends.length > 0) { %>
        <% user.friends.forEach(friendUsername => { %>
          <% const friend = users.find(u => u.username === friendUsername); %>
          <% if (friend) { %>
            <div class="server-item w-full mx-auto p-2 rounded-md flex items-center hover:bg-gray-700 cursor-pointer group/item" onclick="window.location.href='/dm/<%= friend.id %>'">
              <img src="<%= friend.profilepicture %>" alt="<%= friend.username %> Profile" class="w-8 h-8 rounded-full mr-2" />
              <span class="text-gray-300 font-medium group-hover:opacity-100 transition-all duration-200 opacity-0 group-hover:w-auto w-0 text-ellipsis whitespace-nowrap"><%= friend.username %></span>
            </div>
          <% } %>
        <% }) %>
      <% } %>
    </div>
  </div>

  <style>
    .sidebar::-webkit-scrollbar {
      width: 0px;
      transition: width 0.2s ease-in-out;
    }

    .sidebar:hover::-webkit-scrollbar {
      width: 8px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: #2d3748;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const activeItem = document.querySelector('.server-item.active');
      if (activeItem) {
        document.querySelector('.sidebar').classList.add('expanded');
      }

      const createGroupChatButton = document.getElementById('createGroupChatButton');
      if (createGroupChatButton) {
        createGroupChatButton.addEventListener('click', () => {
          if (typeof window.openGroupChatModal === 'function') {
            window.openGroupChatModal();
          } else {
            console.error('window.openGroupChatModal is not defined.');
          }
        });
      }
    });
  </script>
  <main class="ml-56 md:ml-64 p-8 min-h-screen">

    <% if (typeof message !== 'undefined' && message) { %>
    <div class="mb-4 p-3 rounded-md <%= message.type === 'success' ? 'bg-green-500 text-white' : '' %> <%= message.type
      === 'error' ? 'bg-red-500 text-white' : '' %> <%= message.type === 'warning' ? 'bg-yellow-500 text-gray-900' : ''
      %> <%= message.type === 'info' ? 'bg-blue-500 text-white' : '' %>">
      <%= message.text %>
    </div>
    <% } %>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Send Friend Request</h2>
      <form action="/dashboard/add-friend" method="POST" class="flex flex-col sm:flex-row items-center gap-4">
        <input type="text" name="friendUsername" placeholder="Enter username"
          class="flex-grow p-3 rounded-lg bg-gray-700 text-white focus:bg-gray-600 outline-none transition" required />
        <button type="submit"
          class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300">
          Send Request
        </button>
      </form>
    </section>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Received Friend Requests</h2>
      <ul id="friendRequestsList" class="space-y-3">
        <% if (user.receivedFriendRequests && user.receivedFriendRequests.length> 0) { %>
        <% user.receivedFriendRequests.forEach(requester => { %>
        <li class="flex items-center justify-between bg-gray-700 p-3 rounded-md" id="request-<%= requester %>">
          <span class="text-lg"><%= requester %></span>
          <div class="flex gap-2">
            <form action="/dashboard/accept-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="<%= requester %>">
              <button type="submit"
                class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Accept</button>
            </form>
            <form action="/dashboard/reject-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="<%= requester %>">
              <button type="submit"
                class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Reject</button>
            </form>
          </div>
        </li>
        <% }); %>
        <% } %>
      </ul>
      <% if (!user.receivedFriendRequests || user.receivedFriendRequests.length === 0) { %>
      <p id="noFriendRequests" class="text-gray-400">No pending friend requests.</p>
      <% } %>
    </section>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Sent Friend Requests</h2>
      <ul id="sentFriendRequestsList" class="space-y-3">
        <% if (user.sentFriendRequests && user.sentFriendRequests.length> 0) { %>
        <% user.sentFriendRequests.forEach(sentTo => { %>
        <li class="flex items-center justify-between bg-gray-700 p-3 rounded-md" id="sent-<%= sentTo %>">
          <span class="text-lg"><%= sentTo %></span>
          <span class="text-gray-400 text-sm">Pending</span>
        </li>
        <% }); %>
      </ul>
      <% } else { %>
      <p id="noSentFriendRequests" class="text-gray-400">No outgoing friend requests.</p>
      <% } %>
    </section>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Your Friends</h2>
      <% if (user.friends && user.friends.length> 0) { %>
      <ul id="friendsList" class="space-y-3">
        <% user.friends.forEach(friend => { %>
        <li class="flex items-center justify-between bg-gray-700 p-3 rounded-md" id="friend-<%= friend %>">
          <span class="text-lg"><%= friend %></span>
           <form action="/dashboard/unfriend" method="POST">
              <input type="hidden" name="friendUsername" value="<%= friend %>">
              <button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Unfriend</button>
            </form>
        </li>
        <% }); %>
      </ul>
      <% } else { %>
      <p id="noFriends" class="text-gray-400">You don't have any friends yet. Send a request!</p>
      <% } %>
    </section>

  </main>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const userId = '<%= user.id %>';

    socket.emit('joinRoom', userId);

    socket.on('newFriendRequest', (data) => {
      console.log('New friend request from:', data.from);
      const friendRequestsList = document.getElementById('friendRequestsList');
      const noFriendRequests = document.getElementById('noFriendRequests');

      const newRequest = document.createElement('li');
      newRequest.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-md';
      newRequest.id = `request-${data.from}`;
      newRequest.innerHTML = `
          <span class="text-lg">${data.from}</span>
          <div class="flex gap-2">
            <form action="/dashboard/accept-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="${data.from}">
              <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Accept</button>
            </form>
            <form action="/dashboard/reject-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="${data.from}">
              <button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Reject</button>
            </form>
          </div>
      `;

      friendRequestsList.appendChild(newRequest);

      if (noFriendRequests) {
        noFriendRequests.remove();
      }
    });

    socket.on('friendRequestAccepted', (data) => {
      console.log('friendRequestAccepted:', data);
      const sentFriendRequestsList = document.getElementById('sentFriendRequestsList');
      const sentRequestElement = document.getElementById(`sent-${data.accepterUsername}`);

      if (sentRequestElement) {
        sentRequestElement.remove();
      }

      const friendsList = document.getElementById('friendsList');
      const noFriends = document.getElementById('noFriends');

      const newFriend = document.createElement('li');
        newFriend.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-md';
        newFriend.id = `friend-${data.accepterUsername}`;
        newFriend.innerHTML = `
            <span class="text-lg">${data.accepterUsername}</span>
            <form action="/dashboard/unfriend" method="POST">
                <input type="hidden" name="friendUsername" value="${data.accepterUsername}">
                <button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Unfriend</button>
            </form>
        `;
        friendsList.appendChild(newFriend);

        if (noFriends) {
            noFriends.remove();
        }
    });

    socket.on('friendRequestRejected', (data) => {
      console.log('friendRequestRejected:', data);
      const sentFriendRequestsList = document.getElementById('sentFriendRequestsList');
      const sentRequestElement = document.getElementById(`sent-${data.rejecterUsername}`);

      if (sentRequestElement) {
        sentRequestElement.remove();
      }
        const sentFriendRequestsListElement = document.getElementById('sentFriendRequestsList');
        if (sentFriendRequestsListElement && sentFriendRequestsListElement.children.length === 0) {
            const noSentFriendRequests = document.createElement('p');
            noSentFriendRequests.id = 'noSentFriendRequests';
            noSentFriendRequests.className = 'text-gray-400';
            noSentFriendRequests.textContent = 'No outgoing friend requests.';
            sentFriendRequestsListElement.appendChild(noSentFriendRequests);
        }
    });

    socket.on('unfriended', (data) => {
    console.log('You have been unfriended:', data.unfrienderUsername);
    alert(`You have been unfriended by ${data.unfrienderUsername}!`);
    location.reload();
  });
  </script>

  <%- include('parts/gc-create', { user: user }) %>

<script>
  let currentGroupId = null;

  window.openGroupChatModal = function(groupId = null) {
    currentGroupId = groupId;

    const modal = document.getElementById('createGroupChatModal');
    const form = document.getElementById('createGroupChatForm');
    const modalTitle = document.getElementById('groupChatModalTitle');
    const groupNameDiv = document.getElementById('groupNameDiv');
    const groupNameInput = document.getElementById('groupName');
    const submitButton = document.getElementById('groupChatSubmitButton');

    if (!modal) { console.error('Group Chat Modal element "createGroupChatModal" not found.'); return; }
    if (!form) { console.error('Group Chat Modal element "createGroupChatForm" not found.'); return; }
    if (!modalTitle) { console.error('Group Chat Modal element "groupChatModalTitle" not found.'); return; }
    if (!groupNameDiv) { console.error('Group Chat Modal element "groupNameDiv" not found.'); return; }
    if (!groupNameInput) { console.error('Group Chat Modal element "groupName" not found.'); return; }
    if (!submitButton) { console.error('Group Chat Modal element "groupChatSubmitButton" not found.'); return; }

    form.reset();
    document.querySelectorAll('input[name="participants"]').forEach(cb => cb.checked = false);

    if (currentGroupId) {
      
      modalTitle.textContent = 'Add Members';
      groupNameDiv.classList.add('hidden');
      groupNameInput.removeAttribute('required');
      submitButton.textContent = 'Add Members';

    } else {
      
      modalTitle.textContent = 'Create Group Chat';
      groupNameDiv.classList.remove('hidden');
      groupNameInput.setAttribute('required', 'required');
      submitButton.textContent = 'Create Group Chat';
    }

    modal.classList.remove('hidden');
  }

  window.openCreateGroupChatModal = function() {
    window.openGroupChatModal(null);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('createGroupChatModal');
    const closeButton = document.getElementById('closeGroupChatModal');
    const form = document.getElementById('createGroupChatForm');

    if (!modal || !closeButton || !form) {
      console.warn('Group Chat Modal elements not found. Skipping JS initialization.');
      return;
    }

    closeButton.addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const checkboxes = document.querySelectorAll('input[name="participants"]:checked');
      const participants = Array.from(checkboxes).map(cb => cb.value);

      if (participants.length === 0) {
        alert('Please select at least one friend.');
        return;
      }

      let url;
      let payload;
      let successMessage;
      let failureMessage;

      if (currentGroupId) {
        
        url = `/dashboard/gc/${currentGroupId}/add-members`;
        payload = { participants };
        successMessage = 'Members added successfully!';
        failureMessage = 'Failed to add members:';
      } else {
        
        const groupName = document.getElementById('groupName').value.trim();
        if (!groupName) {
          alert('Please enter a group name.');
          return;
        }
        url = '/dashboard/create-group-chat';
        payload = { groupName, participants };
        successMessage = `Group chat "${groupName}" created successfully!`;
        failureMessage = 'Failed to create group chat:';
      }

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        const result = await response.json();

        if (response.ok) {
          alert(successMessage);
          modal.classList.add('hidden');
          
          if (currentGroupId) {
            
            location.reload();
          } else if (result.groupId) {
            
            window.location.href = `/gc/${result.groupId}`;
          } else {
            location.reload();
          }
        } else {
          alert(`${failureMessage} ${result.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        alert('An error occurred while trying to process the request.');
      }
    });
  });
</script>
</body>

</html>