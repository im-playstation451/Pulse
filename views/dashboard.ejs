<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" src="/others/pulse.png" />
  <title>Pulse - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-r from-gray-900 to-gray-800 font-sans text-white antialiased min-h-screen">
  <%- include('parts/sidebar', { user: user, users: users }) %>
  <main class="ml-56 md:ml-64 p-8 min-h-screen">

    <% if (typeof message !== 'undefined' && message) { %>
    <div class="mb-4 p-3 rounded-md <%= message.type === 'success' ? 'bg-green-500 text-white' : '' %> <%= message.type
      === 'error' ? 'bg-red-500 text-white' : '' %> <%= message.type === 'warning' ? 'bg-yellow-500 text-gray-900' : ''
      %> <%= message.type === 'info' ? 'bg-blue-500 text-white' : '' %>">
      <%= message.text %>
    </div>
    <% } %>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Send Friend Request</h2>
      <form action="/dashboard/add-friend" method="POST" class="flex flex-col sm:flex-row items-center gap-4">
        <input type="text" name="friendUsername" placeholder="Enter username"
          class="flex-grow p-3 rounded-lg bg-gray-700 text-white focus:bg-gray-600 outline-none transition" required />
        <button type="submit"
          class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300">
          Send Request
        </button>
      </form>
    </section>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Received Friend Requests</h2>
      <ul id="friendRequestsList" class="space-y-3">
        <% if (user.receivedFriendRequests && user.receivedFriendRequests.length> 0) { %>
        <% user.receivedFriendRequests.forEach(requester => { %>
        <li class="flex items-center justify-between bg-gray-700 p-3 rounded-md" id="request-<%= requester %>">
          <span class="text-lg"><%= requester %></span>
          <div class="flex gap-2">
            <form action="/dashboard/accept-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="<%= requester %>">
              <button type="submit"
                class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Accept</button>
            </form>
            <form action="/dashboard/reject-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="<%= requester %>">
              <button type="submit"
                class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Reject</button>
            </form>
          </div>
        </li>
        <% }); %>
        <% } %>
      </ul>
      <% if (!user.receivedFriendRequests || user.receivedFriendRequests.length === 0) { %>
      <p id="noFriendRequests" class="text-gray-400">No pending friend requests.</p>
      <% } %>
    </section>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Sent Friend Requests</h2>
      <ul id="sentFriendRequestsList" class="space-y-3">
        <% if (user.sentFriendRequests && user.sentFriendRequests.length> 0) { %>
        <% user.sentFriendRequests.forEach(sentTo => { %>
        <li class="flex items-center justify-between bg-gray-700 p-3 rounded-md" id="sent-<%= sentTo %>">
          <span class="text-lg"><%= sentTo %></span>
          <span class="text-gray-400 text-sm">Pending</span>
        </li>
        <% }); %>
      </ul>
      <% } else { %>
      <p id="noSentFriendRequests" class="text-gray-400">No outgoing friend requests.</p>
      <% } %>
    </section>

    <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Your Friends</h2>
      <% if (user.friends && user.friends.length> 0) { %>
      <ul id="friendsList" class="space-y-3">
        <% user.friends.forEach(friend => { %>
        <li class="flex items-center justify-between bg-gray-700 p-3 rounded-md" id="friend-<%= friend %>">
          <span class="text-lg"><%= friend %></span>
           <form action="/dashboard/unfriend" method="POST">
              <input type="hidden" name="friendUsername" value="<%= friend %>">
              <button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Unfriend</button>
            </form>
        </li>
        <% }); %>
      </ul>
      <% } else { %>
      <p id="noFriends" class="text-gray-400">You don't have any friends yet. Send a request!</p>
      <% } %>
    </section>

  </main>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const userId = '<%= user.id %>';

    socket.emit('joinRoom', userId);

    socket.on('newFriendRequest', (data) => {
      console.log('New friend request from:', data.from);
      const friendRequestsList = document.getElementById('friendRequestsList');
      const noFriendRequests = document.getElementById('noFriendRequests');

      const newRequest = document.createElement('li');
      newRequest.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-md';
      newRequest.id = `request-${data.from}`;
      newRequest.innerHTML = `
          <span class="text-lg">${data.from}</span>
          <div class="flex gap-2">
            <form action="/dashboard/accept-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="${data.from}">
              <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Accept</button>
            </form>
            <form action="/dashboard/reject-friend-request" method="POST">
              <input type="hidden" name="requesterUsername" value="${data.from}">
              <button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Reject</button>
            </form>
          </div>
      `;

      friendRequestsList.appendChild(newRequest);

      if (noFriendRequests) {
        noFriendRequests.remove();
      }
    });

    socket.on('friendRequestAccepted', (data) => {
      console.log('friendRequestAccepted:', data);
      const sentFriendRequestsList = document.getElementById('sentFriendRequestsList');
      const sentRequestElement = document.getElementById(`sent-${data.accepterUsername}`);

      if (sentRequestElement) {
        sentRequestElement.remove();
      }

      const friendsList = document.getElementById('friendsList');
      const noFriends = document.getElementById('noFriends');

      const newFriend = document.createElement('li');
        newFriend.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-md';
        newFriend.id = `friend-${data.accepterUsername}`;
        newFriend.innerHTML = `
            <span class="text-lg">${data.accepterUsername}</span>
            <form action="/dashboard/unfriend" method="POST">
                <input type="hidden" name="friendUsername" value="${data.accepterUsername}">
                <button type="submit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 text-sm">Unfriend</button>
            </form>
        `;
        friendsList.appendChild(newFriend);

        if (noFriends) {
            noFriends.remove();
        }
    });

    socket.on('friendRequestRejected', (data) => {
      console.log('friendRequestRejected:', data);
      const sentFriendRequestsList = document.getElementById('sentFriendRequestsList');
      const sentRequestElement = document.getElementById(`sent-${data.rejecterUsername}`);

      if (sentRequestElement) {
        sentRequestElement.remove();
      }
        const sentFriendRequestsListElement = document.getElementById('sentFriendRequestsList');
        if (sentFriendRequestsListElement && sentFriendRequestsListElement.children.length === 0) {
            const noSentFriendRequests = document.createElement('p');
            noSentFriendRequests.id = 'noSentFriendRequests';
            noSentFriendRequests.className = 'text-gray-400';
            noSentFriendRequests.textContent = 'No outgoing friend requests.';
            sentFriendRequestsListElement.appendChild(noSentFriendRequests);
        }
    });

    socket.on('unfriended', (data) => {
    console.log('You have been unfriended:', data.unfrienderUsername);
    alert(`You have been unfriended by ${data.unfrienderUsername}!`);
    location.reload();
  });
  </script>
</body>

</html>