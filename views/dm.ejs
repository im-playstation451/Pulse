<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" src="/others/pulse.png">
  <title>Pulse - DM with <%= targetUser.username %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    .message-area::-webkit-scrollbar {
      width: 8px;
    }

    .message-area::-webkit-scrollbar-track {
      background: #2d3748;
    }

    .message-area::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }

    .message-area::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }

    body::-webkit-scrollbar {
      width: 4px;
    }

    body::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    body::-webkit-scrollbar-thumb {
      background: #7289da;
    }

    body::-webkit-scrollbar-thumb:hover {
      background: #6372e9;
    }
  </style>
</head>

<body
  class="bg-gradient-to-r from-gray-900 to-gray-800 font-sans text-white antialiased min-h-screen flex">

  <div
    class="flex flex-col flex-1 {{ 'ml-14 transition-all duration-200 hover:ml-40' if sidebar was present }}">
    <header class="bg-gray-900 border-b border-gray-700 p-4 flex items-center shadow-md sticky top-0 z-10">
      <a href="/dashboard" class="mr-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </a>
      <img src="<%= targetUser.profilepicture %>" alt="<%= targetUser.username %> Profile"
        class="w-10 h-10 rounded-full mr-3" />
      <div class="flex flex-col">
        <h1 class="text-xl font-semibold"><%= targetUser.username %></h1>
        <p class="text-sm text-gray-400">Online</p>
      </div>
      <div class="ml-auto flex items-center space-x-2">
        <button class="p-2 rounded-full hover:bg-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
            </path>
          </svg>
        </button>
      </div>
    </header>

    <main class="flex-1 p-4 overflow-y-auto message-area">
      <div id="messages" class="space-y-4">
        <% messages.forEach(message => { %>
        <% if (message.type === 'image') { %>
        <div class="flex <%= message.senderId === user.id ? 'justify-end' : 'justify-start' %>">
          <div class="bg-<%= message.senderId === user.id ? 'blue-700' : 'gray-700' %> text-white p-3 rounded-xl max-w-xs break-words shadow-md">
            <img src="<%= message.content %>" alt="Image" class="max-w-xs rounded-xl shadow-md" />
            <div class="text-xs text-<%= message.senderId === user.id ? 'blue-200' : 'gray-400' %> mt-1 text-<%= message.senderId === user.id ? 'right' : 'left' %>">
              <%= new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
            </div>
          </div>
        </div>
        <% } else { %>
        <div class="flex <%= message.senderId === user.id ? 'justify-end' : 'justify-start' %>">
          <div class="bg-<%= message.senderId === user.id ? 'blue-700' : 'gray-700' %> text-white p-3 rounded-xl max-w-xs break-words shadow-md">
            <span class="encrypted-message" data-encrypted-content="<%= message.content %>">Loading...</span>
            <div class="text-xs text-<%= message.senderId === user.id ? 'blue-200' : 'gray-400' %> mt-1 text-<%= message.senderId === user.id ? 'right' : 'left' %>">
              <%= new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
            </div>
          </div>
        </div>
        <% } %>
        <% }) %>
      </div>
    </main>

    <div class="bg-gray-900 border-t border-gray-700 p-4 sticky bottom-0">
      <form id="messageForm" class="flex items-center gap-4">
        <input type="text" id="messageInput" placeholder="Type your message..."
          class="flex-grow p-3 rounded-full bg-gray-800 text-white focus:bg-gray-700 outline-none transition"
          autocomplete="off" required />
        <input type="file" id="fileInput" class="hidden" accept="image/*, image/gif" />
        <div class="relative">
          <label for="fileInput"
            class="cursor-pointer p-3 rounded-full hover:bg-gray-700 transition">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
              </path>
            </svg>
          </label>
          <span id="pasteIndicator" class="absolute top-0 right-0 flex h-3 w-3 hidden">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-sky-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3 bg-sky-500"></span>
          </span>
        </div>
        <button type="submit"
          class="bg-blue-700 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-md transition duration-300">
          Send
        </button>
      </form>
      <div id="imagePreview" class="mt-2"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const messageArea = document.querySelector('.message-area');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const messagesDiv = document.getElementById('messages');
      const fileInput = document.getElementById('fileInput');
      const imagePreview = document.getElementById('imagePreview');

      const socket = io();

      socket.emit('joinRoom', '<%= user.id %>');

      function scrollToBottom() {
        messageArea.scrollTop = messageArea.scrollHeight;
      }

      function decryptExistingMessages() {
        const secretKey = 'my-secret-key';

        document.querySelectorAll('.encrypted-message').forEach(span => {
          const encryptedContent = span.dataset.encryptedContent;
          if (encryptedContent) {
            try {
              const decryptedContent = CryptoJS.AES.decrypt(encryptedContent, secretKey).toString(CryptoJS.enc.Utf8);
              span.textContent = decryptedContent;
            } catch (error) {
              console.error('Decryption error for existing message:', error);
              span.textContent = 'Failed to decrypt message';
            }
          }
        });
      }

      const checkCryptoJSInterval = setInterval(() => {
        if (typeof CryptoJS !== 'undefined' && CryptoJS.AES) {
          clearInterval(checkCryptoJSInterval);
          decryptExistingMessages();
          scrollToBottom();
        }
      }, 100);

      scrollToBottom();


      function displayMessage(msg) {
        const isCurrentUser = msg.senderId === '<%= user.id %>';
        const messageElement = document.createElement('div');
        messageElement.classList.add('flex', isCurrentUser ? 'justify-end' : 'justify-start');

        const secretKey = 'my-secret-key';

        let decryptedContent = '';
        if (typeof CryptoJS !== 'undefined') {
          try {
            decryptedContent = CryptoJS.AES.decrypt(msg.content, secretKey).toString(CryptoJS.enc.Utf8);
          } catch (error) {
            decryptedContent = 'Failed to decrypt message';
            console.error('Decryption error:', error);
          }
        } else {
          decryptedContent = 'CryptoJS not loaded';
        }


        let messageContent = '';
        if (msg.type === 'image') {
          messageContent = `<img src="${msg.content}" alt="Image" class="max-w-xs rounded-xl shadow-md" />`;
        } else {
          messageContent = decryptedContent;
        }

        messageElement.innerHTML = `
          <div class="bg-${isCurrentUser ? 'blue-700' : 'gray-700'} text-white p-3 rounded-xl max-w-xs break-words shadow-md">
            ${messageContent}
            <div class="text-xs text-${isCurrentUser ? 'blue-200' : 'gray-400'} mt-1 text-${isCurrentUser ? 'right' : 'left'}">
              ${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
          </div>
        `;

        messagesDiv.appendChild(messageElement);
        scrollToBottom();
      }

      socket.on('chat message', (msg) => {
        console.log('Message received:', msg);
        displayMessage(msg);
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const imageUrl = event.target.result;
            imagePreview.innerHTML = `<img src="${imageUrl}" alt="Preview" class="max-h-48 rounded-xl" />`;
          };
          reader.readAsDataURL(file);
        }
      });

      document.addEventListener('paste', (event) => {
        const items = (event.clipboardData || event.clipboardData).items;
        let blob = null;

        for (let i = 0; i < items.length; i++) {
          if (items[i.type.indexOf("image") === 0]) {
            blob = items[i].getAsFile();
            break;
          }
        }

        if (blob) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const imageData = event.target.result;
            socket.emit('chat message', {
              senderId: '<%= user.id %>',
              receiverId: '<%= targetUser.id %>',
              type: 'image',
              content: imageData
            });
            imagePreview.innerHTML = '';
            fileInput.value = '';
            const pasteIndicator = document.getElementById('pasteIndicator');
            pasteIndicator.classList.add('hidden');
          };
          reader.readAsDataURL(blob);
          const pasteIndicator = document.getElementById('pasteIndicator');
          pasteIndicator.classList.add('hidden');
        } else {
          const pasteIndicator = document.getElementById('pasteIndicator');
          pasteIndicator.classList.remove('hidden');
          setTimeout(() => {
            pasteIndicator.classList.add('hidden');
          }, 3000)
        }
      });

      messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const messageContent = messageInput.value.trim();
        const file = fileInput.files[0];

        if (!messageContent && !file) return;

        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const imageData = event.target.result;
            socket.emit('chat message', {
              senderId: '<%= user.id %>',
              receiverId: '<%= targetUser.id %>',
              type: 'image',
              content: imageData
            });
            imagePreview.innerHTML = '';
            fileInput.value = '';
          };
          reader.readAsDataURL(file);
        } else {
          socket.emit('chat message', {
            senderId: '<%= user.id %>',
            receiverId: '<%= targetUser.id %>',
            type: 'text',
            content: messageContent
          });
        }

        messageInput.value = '';
      });
    });
  </script>
</body>

</html>

